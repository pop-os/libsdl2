From: Simon McVittie <smcv@collabora.com>
Date: Tue, 12 Apr 2022 13:42:04 +0100
Subject: test: Install GNOME-style installed-tests metadata

This allows these tests to be discovered and run by
gnome-desktop-test-runner.

Signed-off-by: Simon McVittie <smcv@collabora.com>
Forwarded: https://github.com/libsdl-org/SDL/pull/5525
---
 test/Makefile.in | 20 ++++++++++++++++----
 1 file changed, 16 insertions(+), 4 deletions(-)

diff --git a/test/Makefile.in b/test/Makefile.in
index 7a8b2e3..242e260 100644
--- a/test/Makefile.in
+++ b/test/Makefile.in
@@ -88,16 +88,28 @@ TARGETS = \
 @OPENGLES2_TARGETS@ += testgles2$(EXE)
 
 
-all: Makefile $(TARGETS) copydatafiles
+all: Makefile $(TARGETS) copydatafiles generatetestmeta
 
 installedtestsdir = $(libexecdir)/installed-tests/SDL2
-
-install:
+installedtestsmetadir = $(datadir)/installed-tests/SDL2
+
+generatetestmeta:
+	rm -f *.test
+	set -e; for exe in $(noninteractive) $(needs_audio) $(needs_display); do \
+		( \
+			echo '[Test]'; \
+			echo 'Type=session'; \
+			echo "Exec=$(installedtestsdir)/$$exe"; \
+		) > $$exe.test; \
+	done
+
+install: generatetestmeta
 	install -D -t $(DESTDIR)$(installedtestsdir) $(TARGETS)
 	install -m644 -D -t $(DESTDIR)$(installedtestsdir) $(wildcard $(srcdir)/*.bmp)
 	install -m644 -D -t $(DESTDIR)$(installedtestsdir) $(wildcard $(srcdir)/*.dat)
 	install -m644 -D -t $(DESTDIR)$(installedtestsdir) $(wildcard $(srcdir)/*.txt)
 	install -m644 -D -t $(DESTDIR)$(installedtestsdir) $(wildcard $(srcdir)/*.wav)
+	install -m644 -D -t $(DESTDIR)$(installedtestsmetadir) *.test
 
 Makefile: $(srcdir)/Makefile.in
 	$(SHELL) config.status $@
@@ -365,7 +377,7 @@ testmouse$(EXE): $(srcdir)/testmouse.c
 
 
 clean:
-	rm -f $(TARGETS)
+	rm -f $(TARGETS) *.test
 
 distclean: clean
 	rm -f Makefile
